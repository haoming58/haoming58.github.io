---
layout: note_with_toc
title: 6 é€šè¿‡æ—¶é—´åå‘ä¼ æ’­
description: Building RNN from scratch with detailed implementation
category: Machine Learning
tags: [RNN, Deep Learning, Neural Networks, PyTorch, Implementation]
permalink: /notes/é€šè¿‡æ—¶é—´åå‘ä¼ æ’­/
---

# 6. é€šè¿‡æ—¶é—´åå‘ä¼ æ’­

è¿™éƒ¨ä»½å°†ä¼šæ¨¡å‹çš„åå‘ä¼ æ’­ å’Œ detach æ›´å¥½åœ°è§£é‡Šå’Œä½¿ç”¨ã€‚

## 6.1 é€šè¿‡æ—¶é—´åå‘ä¼ æ’­ç®€ä»‹

åå‘ä¼ æ’­ï¼Œæœ¬èº«æ˜¯ä»ç»“æœå¾€åé¢æ±‚æ¢¯åº¦ï¼ŒåŸºäºè¿™é‡Œçš„æ•°æ®æ˜¯åºåˆ—æœ‰æ—¶é—´ä¿¡æ¯ï¼Œå› æ­¤ï¼Œä»æ—¶é—´çš„åé¢è®¡ç®—ï¼Œè¿™é‡Œå°±å¯ä»¥ç†è§£ä¸ºä»æ—¶é—´ç©¿è¶Šã€‚

å½“ç„¶ï¼Œè¿˜éœ€è¦è€ƒè™‘çš„æ˜¯è®¡ç®—å›¾ã€‚


### 6.1.1 éšè—çŠ¶æ€çš„æ›´æ–°ï¼ˆActivation of the Hidden Stateï¼‰ï¼š

$$h_t = f(W_h h_{t-1} + W_x x_t)$$

* **$h_t$**: ç¬¬ $t$ æ—¶åˆ»çš„**éšè—çŠ¶æ€**ã€‚å®ƒæ•è·äº†ä»åºåˆ—å¼€å§‹åˆ° $t$ æ—¶åˆ»çš„æ‰€æœ‰ä¿¡æ¯ã€‚
* **$h_{t-1}$**: ä¸Šä¸€ä¸ªæ—¶åˆ»ï¼ˆ$t-1$ï¼‰çš„éšè—çŠ¶æ€ã€‚
* **$x_t$**: å½“å‰æ—¶åˆ» $t$ çš„**è¾“å…¥**ã€‚
* **$W_x$**: è¿æ¥è¾“å…¥ $x_t$ åˆ°éšè—å±‚ $h_t$ çš„**æƒé‡çŸ©é˜µ**ã€‚
* **$W_h$**: è¿æ¥ä¸Šä¸€æ—¶åˆ»éšè—çŠ¶æ€ $h_{t-1}$ åˆ°å½“å‰éšè—å±‚ $h_t$ çš„**æƒé‡çŸ©é˜µ**ã€‚
    * **å…³é”®ç‚¹**: $W_x$ å’Œ $W_h$ åœ¨æ‰€æœ‰æ—¶é—´æ­¥ $t$ éƒ½æ˜¯**å…±äº«**çš„ï¼Œè¿™æ˜¯ RNN çš„æ ¸å¿ƒç‰¹å¾ã€‚
* **$f$**: éçº¿æ€§æ¿€æ´»å‡½æ•°ï¼ˆå¦‚ $\tanh$ æˆ– $\text{ReLU}$ï¼‰ï¼Œç”¨äºå¼•å…¥éçº¿æ€§ï¼Œä½¿ç½‘ç»œèƒ½å­¦ä¹ æ›´å¤æ‚çš„æ¨¡å¼ã€‚

$$y_t = g(W_y h_t)$$

* **$y_t$**: ç¬¬ $t$ æ—¶åˆ»çš„**è¾“å‡º**ï¼ˆä¾‹å¦‚ï¼Œä¸‹ä¸€ä¸ªè¯çš„æ¦‚ç‡åˆ†å¸ƒï¼‰ã€‚
* **$W_y$**: è¿æ¥éšè—çŠ¶æ€ $h_t$ åˆ°è¾“å‡º $y_t$ çš„**æƒé‡çŸ©é˜µ**ã€‚
* **$g$**: å¦ä¸€ä¸ªéçº¿æ€§æ¿€æ´»å‡½æ•°ï¼ˆä¾‹å¦‚ï¼Œå¯¹äºåˆ†ç±»ä»»åŠ¡ï¼Œé€šå¸¸æ˜¯ $\text{softmax}$ï¼‰ã€‚

### 6.1.2 ç›®æ ‡å‡½æ•°ï¼ˆObjective/Loss Functionï¼‰


$$L = \sum_{t=1}^{T} \ell(y_t, \hat{y}_t)$$

* **$L$**: æ•´ä¸ªåºåˆ—çš„**æ€»æŸå¤±**ã€‚
* **$T$**: åºåˆ—çš„**æ€»æ—¶é—´æ­¥é•¿**ã€‚
* **$\ell(y_t, \hat{y}_t)$**: åœ¨**å•ä¸ªæ—¶é—´æ­¥ $t$** ä¸Šçš„æŸå¤±å‡½æ•°ï¼ˆä¾‹å¦‚ï¼Œäº¤å‰ç†µæŸå¤±æˆ–å‡æ–¹è¯¯å·®ï¼‰ã€‚
    * **$\hat{y}_t$**: ç¬¬ $t$ æ—¶åˆ»çš„**çœŸå®æ ‡ç­¾æˆ–ç›®æ ‡å€¼**ï¼ˆGround Truthï¼‰ã€‚
    * **$y_t$**: ç¬¬ $t$ æ—¶åˆ»çš„**æ¨¡å‹é¢„æµ‹è¾“å‡º**ã€‚

è¿™é‡Œå®é™…ä¸Šå°±æ˜¯æ¯ä¸ªæ—¶é—´æ­¥ä¸ŠæŸå¤±å‡½æ•°ä¹‹å’ŒåŠ åœ¨ä¸€èµ·ä½¿å¾—

**è®­ç»ƒç›®æ ‡**ï¼šé€šè¿‡è°ƒæ•´æƒé‡å‚æ•° $W_x, W_h, W_y$ï¼Œä½¿æ€»æŸå¤± $L$ **æœ€å°åŒ–**ã€‚

## 6.2 æ¢¯åº¦æ¨å¯¼

æœ‰ä¸‰ä¸ªåŸºæœ¬å‚æ•°ï¼š$W_h, W_x, W_y$


å¯¹äºè¾“å‡ºå±‚æƒé‡ $W_y$ï¼Œç”±äºå®ƒåªå½±å“**å½“å‰æ—¶é—´æ­¥ $t$ çš„è¾“å‡º $y_t$**ï¼Œæ‰€ä»¥æ¢¯åº¦è®¡ç®—ç›¸å¯¹ç›´æ¥ï¼Œä¸éœ€è¦è¿½æº¯åˆ°è¿‡å»çš„éšçŠ¶æ€ï¼š

$$\frac{\partial L}{\partial W_y} = \sum_{t} \frac{\partial \ell_t}{\partial y_t} \frac{\partial y_t}{\partial W_y}$$

* $L$: æ€»æŸå¤±ã€‚
* $\ell_t$: æ—¶é—´æ­¥ $t$ çš„æŸå¤±ã€‚


$$\frac{\partial L_t}{\partial W_h} = \frac{\partial L_t}{\partial y_t} \frac{\partial y_t}{\partial h_t} \frac{\partial h_t}{\partial W_h}$$



\[ \mathbf{L} \xrightarrow{\text{å…³äº } y} \mathbf{y}_t \xrightarrow{\text{å…³äº } h} \mathbf{h}_t \xrightarrow{\text{å…³äº } W_h} \mathbf{W}_h\]


è¿™é‡Œçš„å…³é”®æ˜¯åœ¨äºæœ€åä¸€é¡¹ï¼š


$$h_t = f(W_h h_{t-1} + W_x x_t + b)$$

é—®é¢˜çš„å…³é”®å°±åœ¨äºäº§ç”Ÿäº†é€’å½’ï¼Œæˆ‘è¿™é‡Œä¸ç†è§£çš„æ˜¯: æ¢¯åº¦çš„åå‘ä¼ æ’­åŸç†ï¼Œéšç€æ—¶é—´çš„è·¯å¾„ä¼ æ’­ï¼š

åŸºäºä¸Šè¿°çš„é—®é¢˜ï¼Œè¿›è¡Œæ€è€ƒå’Œå›é¡¾ï¼š

åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œä¸€ä¸ªå˜é‡å¾€å¾€é€šè¿‡å¤šæ¡è·¯å¾„å½±å“æœ€ç»ˆç»“æœï¼Œæˆ–è€…æœ€ç»ˆç»“æœä¾èµ–äºå¤šä¸ªä¸­é—´å˜é‡ã€‚å‡è®¾ $L$ ä¾èµ–äº $Y$ å’Œ $Z$ï¼Œè€Œ $Y$ å’Œ $Z$ éƒ½ä¾èµ–äº $W$ï¼š$$L = f(Y, Z) \quad \text{ä¸”} \quad Y = g(W), Z = h(W)$$æˆ‘ä»¬è¦è®¡ç®— $L$ å¯¹ $W$ çš„æ¢¯åº¦ $\frac{\partial L}{\partial W}$ã€‚å…¬å¼ï¼š$$\frac{\partial L}{\partial W} = \frac{\partial L}{\partial Y} \frac{dY}{dW} + \frac{\partial L}{\partial Z} \frac{dZ}{dW}$$
- å…³é”®å˜åŒ–ï¼šåå¯¼æ•° $\partial$ï¼š å½“ä¸€ä¸ªå‡½æ•°æœ‰å¤šä¸ªè¾“å…¥æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨åå¯¼æ•°ã€‚æ±‚å’Œ $\sum$ï¼š å¦‚æœ $W$ é€šè¿‡å¤šæ¡è·¯å¾„ï¼ˆ$Y$ å’Œ $Z$ï¼‰å½±å“ $L$ï¼Œä½ éœ€è¦å°†æ‰€æœ‰è·¯å¾„çš„è´¡çŒ®ç›¸åŠ ã€‚

- æ¯”å–»ï¼š ä½ çš„åŠªåŠ› $W$ å½±å“ä½ çš„æˆç»© $L$ã€‚ä½ çš„åŠªåŠ› $W$ å½±å“äº†ä½ çš„å­¦ä¹ æ—¶é—´ $Y$ã€‚ä½ çš„åŠªåŠ› $W$ ä¹Ÿå½±å“äº†ä½ çš„ç¡çœ æ—¶é—´ $Z$ã€‚

- æ€»æˆç»©å˜åŒ– $\frac{\partial L}{\partial W}$ ç­‰äºï¼š

    è·¯å¾„ä¸€ï¼š å­¦ä¹ æ—¶é—´ $Y$ å¯¹æˆç»©çš„å½±å“ ($\frac{\partial L}{\partial Y}$) ä¹˜ä»¥ åŠªåŠ› $W$ å¯¹å­¦ä¹ æ—¶é—´ $Y$ çš„å½±å“ ($\frac{dY}{dW}$)
    è·¯å¾„äºŒï¼š ç¡çœ æ—¶é—´ $Z$ å¯¹æˆç»©çš„å½±å“ ($\frac{\partial L}{\partial Z}$) ä¹˜ä»¥ åŠªåŠ› $W$ å¯¹ç¡çœ æ—¶é—´ $Z$ çš„å½±å“ ($\frac{dZ}{dW}$)

è¿™é‡Œè¿˜æœ‰éœ€è¦ä¸»è¦çš„æ˜¯ï¼š

å¥½çš„ï¼Œè¿™æ˜¯å¯¹ BPTT ä¸­**é“¾å¼æ³•åˆ™ç®€åŒ–**çš„é€»è¾‘æ•´ç†ã€‚

### ç®€åŒ– BPTT é“¾å¼æ³•åˆ™ï¼šæŠ½è±¡ä¸èšç„¦

åœ¨ BPTT ä¸­ï¼Œå½“æˆ‘ä»¬è®¡ç®—å‚æ•°ï¼ˆå¦‚ $W_h$ï¼‰å¯¹**å½“å‰æ—¶åˆ»æŸå¤± $\ell_t$** çš„æ¢¯åº¦æ—¶ï¼Œå®Œæ•´çš„é“¾å¼æ³•åˆ™æ˜¯ï¼š

$$\frac{\partial \ell_t}{\partial W_h} = \left( \frac{\partial \ell_t}{\partial y_t} \cdot \frac{\partial y_t}{\partial h_t} \right) \cdot \frac{\partial h_t}{\partial W_h}$$

(å³ $W_h \to h_t \to y_t \to \ell_t$)

ä¸ºäº†ç®€åŒ–æ¨å¯¼å¹¶ä¸“æ³¨äº BPTT çš„æ ¸å¿ƒéš¾é¢˜ï¼Œæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

**1. æŠ½è±¡ä¸ç®€åŒ– (Abstraction)**

æˆ‘ä»¬å°† $h_t \to y_t \to \ell_t$ è¿™ä¸ªâ€œä¸­é—´éƒ¨åˆ†â€æ‰“åŒ…ï¼š

$$\frac{\partial \ell_t}{\partial h_t} \equiv \left( \frac{\partial \ell_t}{\partial y_t} \cdot \frac{\partial y_t}{\partial h_t} \right)$$

* **ä¸ºä»€ä¹ˆå¯ä»¥è¿™æ ·åšï¼Ÿ**
    * è¿™æ¡è·¯å¾„ $h_t \to y_t \to \ell_t$ æ˜¯**å±€éƒ¨çš„ (local)** å’Œ**éé€’å½’çš„ (non-recursive)**ã€‚
    * å®ƒ**åªå‘ç”Ÿåœ¨å½“å‰æ—¶é—´æ­¥ $t$ å†…éƒ¨**ï¼Œä¸ä¾èµ– $t-1$ æˆ– $t+1$ æ—¶åˆ»ã€‚
* **ä½œç”¨ï¼š**
    * æˆ‘ä»¬æŠŠå®ƒè§†ä¸ºä¸€ä¸ªå·²çŸ¥çš„ã€å¯ä»¥è½»æ¾è®¡ç®—çš„â€œé»‘ç›’â€ã€‚
    * $\frac{\partial \ell_t}{\partial h_t}$ å°±æ˜¯è¿™ä¸ªé»‘ç›’çš„å¯¼æ•°ï¼Œä»£è¡¨**â€œ$h_t$ å¯¹å½“å‰ $\ell_t$ çš„å±€éƒ¨å½±å“â€**ã€‚

**2. èšç„¦æ ¸å¿ƒé—®é¢˜ (Focus)**

BPTT çš„çœŸæ­£å›°éš¾**ä¸åœ¨äº** $h_t \to \ell_t$ è¿™ä¸ªå±€éƒ¨è®¡ç®—ã€‚

BPTT çš„çœŸæ­£å›°éš¾åœ¨äº**æ—¶é—´è½´ä¸Šçš„ä¾èµ–å…³ç³»**ï¼Œå³ï¼š

* **æ¥è‡ªæœªæ¥çš„é€’å½’ï¼š** $h_t$ å¦‚ä½•è¢«**æœªæ¥**çš„ $\ell_{t+1}, \dots, \ell_T$ å½±å“ï¼ˆé€šè¿‡ $\frac{\partial L}{\partial h_{t+1}}$ ä¼ å›ï¼‰ã€‚
* **æ¥è‡ªè¿‡å»çš„é•¿é“¾ï¼š** $h_t$ å¦‚ä½•è¢«**è¿‡å»**çš„ $W_h$ å½±å“ï¼ˆé€šè¿‡ $\frac{\partial h_t}{\partial h_{t-1}} \dots$ ä¼ å¯¼ï¼‰ã€‚

**3. ç»“è®ºï¼šç®€åŒ–çš„æ ¸å¿ƒå…¬å¼**

é€šè¿‡å°† $h_t \to y_t \to \ell_t$ ç®€åŒ–ä¸º $\frac{\partial \ell_t}{\partial h_t}$ï¼Œæˆ‘ä»¬æ¸…ç†äº†å…¬å¼ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿæ›´æ¸…æ™°åœ°çœ‹åˆ°å¹¶ä¸“æ³¨äº BPTT çš„**æ ¸å¿ƒé€’å½’ç»“æ„**ï¼ˆå³æ€»è¯¯å·®ä¿¡å· $\frac{\partial L}{\partial h_t}$ çš„è®¡ç®—ï¼‰ï¼š

$$\frac{\partial L}{\partial h_t} = \underbrace{\frac{\partial \ell_t}{\partial h_t}}_{\text{ç®€åŒ–çš„å±€éƒ¨å½±å“}} + \underbrace{\frac{\partial L}{\partial h_{t+1}} \frac{\partial h_{t+1}}{\partial h_t}}_{\text{çœŸæ­£çš„ã€è·¨æ—¶é—´çš„é€’å½’éš¾é¢˜}}$$





### 6.2.2 å…³é”®çš„é“¾å¼æ³•åˆ™å±•å¼€ï¼šè¯¯å·®ä¿¡å·çš„é€’æ¨

åœ¨RNNä¸­ï¼ŒåŸºäºå¤šå˜é‡å¾®ç§¯åˆ†çš„é“¾å¼æ³•åˆ™ï¼š

$W_h$ æ˜¯æ‰€æœ‰æ—¶é—´æ­¥ä¸Šå…±äº«å‚æ•°ï¼Œæ„å‘³ç€ï¼Œå½“æ±‚$\frac{\partial L}{\partial W_h}$ï¼Œ éœ€è¦ç»Ÿè®¡æ±‚å’Œ $\sum_{t=1}^T (\dots)$ ï¼Œæœ‰å¤šæ¡è·¯å¾„ã€‚

$$\frac{\partial L}{\partial W_h} = \sum_{t=1}^T \frac{\partial \ell_t}{\partial W_h}$$

æˆ‘ä»¬åœ¨è®¡ç®— $\frac{\partial L}{\partial W_h}$ æ—¶ï¼Œå¼•å…¥ $\frac{\partial L}{\partial h_t}$ æ˜¯ä¸ºäº†è§£è€¦ï¼ˆdecoupleï¼‰è®¡ç®—è¿‡ç¨‹ã€‚

åœ¨ BPTT ä¸­ï¼Œæˆ‘ä»¬æœ€ç»ˆæƒ³è®¡ç®— $W_h$ å’Œ $W_x$ çš„æ¢¯åº¦ã€‚

**1. å¦‚æœæ²¡æœ‰ $\frac{\partial L}{\partial h_t}$ï¼ˆæ•ˆç‡ä½ä¸‹çš„åšæ³•ï¼‰**

å‡è®¾æˆ‘ä»¬è¦è®¡ç®— $W_h$ å’Œ $W_x$ å¯¹ $L$ çš„æ¢¯åº¦ï¼Œå¹¶ä¸”æˆ‘ä»¬ä» $t=T$ ç®—åˆ° $t=1$ã€‚

å½“æˆ‘ä»¬åœ¨ $t=1$ æ—¶åˆ»æ—¶ï¼š
* **è®¡ç®— $\frac{\partial L}{\partial W_h}$ï¼š** æˆ‘ä»¬éœ€è¦è¿½æº¯ $W_h$ é€šè¿‡ $h_1 \to h_2 \to \dots \to h_T$ å½±å“ $L$ çš„æ‰€æœ‰è·¯å¾„ã€‚è¿™ä¸ªè®¡ç®—æ¶‰åŠä¸€ä¸ªæå…¶å¤æ‚çš„ã€æ¨ªè·¨ $T$ ä¸ªæ—¶é—´æ­¥çš„ä¹˜æ³•é“¾ã€‚
* **è®¡ç®— $\frac{\partial L}{\partial W_x}$ï¼š** $W_x$ ä¹Ÿè¦é€šè¿‡ $h_1 \to h_2 \to \dots \to h_T$ å½±å“ $L$ã€‚è¿™ä¸ªè®¡ç®—æ¶‰åŠå¦ä¸€ä¸ªã€ä½†å‡ ä¹å®Œå…¨ç›¸åŒçš„ã€æ¨ªè·¨ $T$ ä¸ªæ—¶é—´æ­¥çš„ä¹˜æ³•é“¾ã€‚

**é—®é¢˜ï¼š** ä¸ºäº†è®¡ç®— $W_h$ å’Œ $W_x$ çš„æ¢¯åº¦ï¼Œæˆ‘ä»¬å¿…é¡»**é‡å¤è®¡ç®—**ä» $h_1$ åˆ° $h_T$ çš„æ‰€æœ‰æ¢¯åº¦ä¼ æ’­é¡¹ã€‚è¿™æµªè´¹äº†å¤§é‡çš„è®¡ç®—èµ„æºã€‚

**2. ä½¿ç”¨ $\frac{\partial L}{\partial h_t}$ï¼ˆé«˜æ•ˆçš„åšæ³•ï¼‰**

æˆ‘ä»¬å¼•å…¥ $\frac{\partial L}{\partial h_t}$ ä½œä¸ºä¸­é—´å˜é‡çš„æ¢¯åº¦ã€‚

å½“æˆ‘ä»¬åœ¨ $t=1$ æ—¶åˆ»æ—¶ï¼š

* **ç¬¬ä¸€æ­¥ï¼šè®¡ç®—å¹¶å­˜å‚¨ $\frac{\partial L}{\partial h_1}$**
    æˆ‘ä»¬ä½¿ç”¨é€’å½’å…¬å¼ï¼ˆä¾èµ–äº $\frac{\partial L}{\partial h_2}, \frac{\partial L}{\partial h_3}, \dots$ è¿™äº›ä¹‹å‰å·²ç»ç®—å¥½çš„å€¼ï¼‰æ¥è®¡ç®— $\frac{\partial L}{\partial h_1}$ã€‚è¿™ä¸ª $\frac{\partial L}{\partial h_1}$ åŒ…å«äº†æ‰€æœ‰æœªæ¥æ—¶åˆ»çš„è¯¯å·®ä¿¡æ¯ã€‚
    * *ï¼ˆé€’å½’å…¬å¼ï¼š$\frac{\partial L}{\partial h_t} = \frac{\partial \ell_t}{\partial h_t} + \frac{\partial L}{\partial h_{t+1}} \frac{\partial h_{t+1}}{\partial h_t}$ï¼‰*

* **ç¬¬äºŒæ­¥ï¼šè®¡ç®— $\frac{\partial L}{\partial W_h}$**
    $$\frac{\partial L}{\partial W_h} \propto \frac{\partial L}{\partial h_1} \cdot \frac{\partial h_1}{\partial W_h}$$
    ï¼ˆæˆ‘ä»¬ä½¿ç”¨ $\frac{\partial L}{\partial h_1}$ï¼‰

* **ç¬¬ä¸‰æ­¥ï¼šè®¡ç®— $\frac{\partial L}{\partial W_x}$**
    $$\frac{\partial L}{\partial W_x} \propto \frac{\partial L}{\partial h_1} \cdot \frac{\partial h_1}{\partial W_x}$$
    ï¼ˆæˆ‘ä»¬å†æ¬¡ä½¿ç”¨ $\frac{\partial L}{\partial h_1}$ï¼‰

#### ä¸¾ä¾‹è¯´æ˜ï¼š

ä¸€ä¸ª $T=10$ çš„åºåˆ—æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œå› ä¸ºå®ƒå¤ªé•¿äº†ï¼Œæ— æ³•æ‰‹åŠ¨å†™å‡ºæ‰€æœ‰é¡¹ï¼Œè¿™æ°æ°çªæ˜¾äº†**ä¸ºä»€ä¹ˆ**å¿…é¡»ä½¿ç”¨é«˜æ•ˆçš„æ–¹æ³•ï¼ˆæ–¹æ³•äºŒï¼‰ã€‚

**ğŸš€ å®é™…ä¾‹å­ï¼šä¸€ä¸ª $T=10$ çš„ RNN**

**æ¨¡å‹è®¾ç½®ï¼š**
* $h_t = W_h h_{t-1} + W_x x_t$
* $L = \sum_{t=1}^{10} \ell_t$ (å‡è®¾ $\ell_t = \frac{1}{2}h_t^2$)

**ç›®æ ‡ï¼š** è®¡ç®— $\frac{\partial L}{\partial W_h}$ å’Œ $\frac{\partial L}{\partial W_x}$ã€‚

**æ–¹æ³•ä¸€ï¼šæ•ˆç‡ä½ä¸‹çš„åšæ³•ï¼ˆç‹¬ç«‹è®¡ç®—ï¼‰**

**ç„¦ç‚¹ï¼šè®¡ç®—ä¸­æœ€æ˜‚è´µçš„å…±äº«éƒ¨åˆ†**

è®©æˆ‘ä»¬åªå…³æ³¨è®¡ç®—ä¸­**æœ€é•¿ã€æœ€æ˜‚è´µ**çš„é‚£æ¡ä¼ æ’­è·¯å¾„ï¼š**ä» $t=1$ çš„è¾“å…¥ï¼Œä¸€ç›´ä¼ æ’­åˆ° $t=10$ çš„æœ€ç»ˆæŸå¤± $\ell_{10}$**ã€‚

è¿™ä¸ªæœ€é•¿çš„è·¯å¾„æ˜¯ï¼š
$$\frac{\partial \ell_{10}}{\partial h_1} = \frac{\partial \ell_{10}}{\partial h_{10}} \cdot \frac{\partial h_{10}}{\partial h_9} \cdot \frac{\partial h_9}{\partial h_8} \cdot \dots \cdot \frac{\partial h_2}{\partial h_1}$$

è¿™ä¸ªè®¡ç®—æ¶‰åŠ 9 æ¬¡çŸ©é˜µä¹˜æ³•ï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯ $h_{10} \cdot W_h \cdot W_h \cdot \dots \cdot W_h = h_{10} \cdot (W_h)^9$ï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸æ˜‚è´µçš„è®¡ç®—ã€‚ï¼ˆ*æ¨å¯¼ï¼š$\frac{\partial \ell_{10}}{\partial h_{10}} = \frac{\partial (\frac{1}{2}h_{10}^2)}{\partial h_{10}} = h_{10}$ | $\frac{\partial h_t}{\partial h_{t-1}} = \frac{\partial (W_h h_{t-1} + W_x x_t)}{\partial h_{t-1}} = W_h$*ï¼‰

**A. è®¡ç®— $\frac{\partial L}{\partial W_x}$**
æ€»æ¢¯åº¦ $\frac{\partial L}{\partial W_x} = \sum_{t=1}^{10} \frac{\partial \ell_t}{\partial W_x}$ã€‚
å½“æˆ‘ä»¬è®¡ç®— $W_x$ åœ¨ $t=1$ æ—¶çš„è´¡çŒ® $\frac{\partial \ell_{10}}{\partial W_x}$ æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ï¼š
$$\left( \frac{\partial \ell_{10}}{\partial h_{10}} \cdot \dots \cdot \frac{\partial h_2}{\partial h_1} \right) \cdot \frac{\partial h_1}{\partial W_x}\big|_{\text{local}}$$
* æˆ‘ä»¬å¿…é¡»è®¡ç®— $h_{10} \cdot (W_h)^9$ è¿™ä¸€é¡¹ã€‚

**B. è®¡ç®— $\frac{\partial L}{\partial W_h}$**
æ€»æ¢¯åº¦ $\frac{\partial L}{\partial W_h} = \sum_{t=1}^{10} \frac{\partial \ell_t}{\partial W_h}$ã€‚
å½“æˆ‘ä»¬è®¡ç®— $W_h$ åœ¨ $t=1$ æ—¶çš„è´¡çŒ® $\frac{\partial \ell_{10}}{\partial W_h}$ æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ï¼š
$$\left( \frac{\partial \ell_{10}}{\partial h_{10}} \cdot \dots \cdot \frac{\partial h_2}{\partial h_1} \right) \cdot \frac{\partial h_1}{\partial W_h}\big|_{\text{local}}$$
* æˆ‘ä»¬**å†ä¸€æ¬¡**å¿…é¡»è®¡ç®— $h_{10} \cdot (W_h)^9$ è¿™ä¸€é¡¹ã€‚

**ä½æ•ˆç‚¹åˆ†æï¼š**
æˆ‘ä»¬ä¸ºäº† $W_x$ è®¡ç®—äº†ä¸€é $h_{10} \cdot (W_h)^9$ï¼Œç„¶ååˆä¸ºäº† $W_h$ **é‡å¤è®¡ç®—**äº†å®Œå…¨ç›¸åŒçš„å€¼ã€‚

è¿™ä¸ä»…ä»…å‘ç”Ÿåœ¨ $\ell_{10} \to h_1$ è¿™æ¡è·¯å¾„ä¸Šã€‚è®¡ç®— $\ell_{10} \to h_2$ã€$\ell_9 \to h_1$ã€$\ell_8 \to h_3$â€¦â€¦**æ¯ä¸€æ¡**è·¨æ—¶é—´çš„è¯¯å·®ä¼ æ’­è·¯å¾„ï¼Œéƒ½å¿…é¡»ä¸º $W_x$ å’Œ $W_h$ **é‡å¤è®¡ç®—**ã€‚

**æ–¹æ³•äºŒï¼šé«˜æ•ˆçš„åšæ³•ï¼ˆä½¿ç”¨ $\frac{\partial L}{\partial h_t}$ï¼‰**

åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆè®¡ç®—å¹¶å­˜å‚¨æ‰€æœ‰è·¨æ—¶é—´çš„è¯¯å·®æ€»å’Œ $\frac{\partial L}{\partial h_t}$ï¼Œç„¶åé‡ç”¨å®ƒä»¬ã€‚

**é˜¶æ®µä¸€ï¼šè®¡ç®—å¹¶å­˜å‚¨ $\frac{\partial L}{\partial h_t}$ï¼ˆå€’åºé€’å½’ï¼‰**

æˆ‘ä»¬ä» $t=10$ å¼€å§‹å€’åºè®¡ç®—ï¼Œ**åªè®¡ç®—ä¸€æ¬¡**ã€‚

1.  **$t=10$:** $\frac{\partial L}{\partial h_{10}} = \frac{\partial \ell_{10}}{\partial h_{10}} = h_{10}$
    * *å­˜å‚¨ $\frac{\partial L}{\partial h_{10}}$*
2.  **$t=9$:** $\frac{\partial L}{\partial h_9} = \frac{\partial \ell_9}{\partial h_9} + \frac{\partial L}{\partial h_{10}} \cdot \frac{\partial h_{10}}{\partial h_9} = h_9 + (\frac{\partial L}{\partial h_{10}} \cdot W_h)$
    * *å­˜å‚¨ $\frac{\partial L}{\partial h_9}$*
... (ä¾æ­¤ç±»æ¨) ...
10. **$t=1$:** $\frac{\partial L}{\partial h_1} = \frac{\partial \ell_1}{\partial h_1} + \frac{\partial L}{\partial h_2} \cdot \frac{\partial h_2}{\partial h_1} = h_1 + (\frac{\partial L}{\partial h_2} \cdot W_h)$
    * *å­˜å‚¨ $\frac{\partial L}{\partial h_1}$*

**å…³é”®ç‚¹ï¼š** å½“æˆ‘ä»¬è®¡ç®— $\frac{\partial L}{\partial h_1}$ æ—¶ï¼Œå®ƒå·²ç»**è‡ªåŠ¨åŒ…å«**äº† $h_{10} \cdot (W_h)^9$ã€$h_9 \cdot (W_h)^8$ ç­‰æ‰€æœ‰æ¥è‡ªæœªæ¥çš„ã€æ˜‚è´µçš„é•¿é“¾ä¹˜ç§¯çš„æ€»å’Œã€‚

**é˜¶æ®µäºŒï¼šä½¿ç”¨ $\frac{\partial L}{\partial h_t}$ è®¡ç®—å‚æ•°ï¼ˆé«˜æ•ˆé‡ç”¨ï¼‰**

ç°åœ¨æˆ‘ä»¬æœ‰äº†æ‰€æœ‰æ‰“åŒ…å¥½çš„è¯¯å·®ä¿¡å· $\frac{\partial L}{\partial h_t}$ ($t=1$ åˆ° $10$)ã€‚

**A. è®¡ç®— $\frac{\partial L}{\partial W_x}$**
$$\frac{\partial L}{\partial W_x} = \sum_{t=1}^{10} \frac{\partial L}{\partial h_t} \cdot \frac{\partial h_t}{\partial W_x}\big|_{\text{local}}$$
$$\frac{\partial L}{\partial W_x} = \sum_{t=1}^{10} \left( \frac{\partial L}{\partial h_t} \cdot x_t \right)$$
*(è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å¾ªç¯ï¼Œåªæ¶‰åŠ**æœ¬åœ°**è®¡ç®—å’Œ**æŸ¥è¡¨**ï¼ˆè¯»å– $\frac{\partial L}{\partial h_t}$ï¼‰)*

**B. è®¡ç®— $\frac{\partial L}{\partial W_h}$**
$$\frac{\partial L}{\partial W_h} = \sum_{t=1}^{10} \frac{\partial L}{\partial h_t} \cdot \frac{\partial h_t}{\partial W_h}\big|_{\text{local}}$$
$$\frac{\partial L}{\partial W_h} = \sum_{t=1}^{10} \left( \frac{\partial L}{\partial h_t} \cdot h_{t-1} \right)$$
*(è¿™åŒæ ·æ˜¯ä¸€ä¸ªç®€å•çš„æœ¬åœ°è®¡ç®—å’ŒæŸ¥è¡¨)*

#### çœŸæ­£çš„ä½æ•ˆç‚¹ï¼š$O(T^2)$ è·¯å¾„

æ‚¨å¯èƒ½ä¼šè§‚å¯Ÿåˆ°ï¼šå¯¹äº**å•ä¸€è·¯å¾„** $\ell_{10} \to h_1$ï¼Œæˆ‘å¯ä»¥åªè®¡ç®—ä¸€æ¬¡ $C = h_{10} \cdot (W_h)^9$ å¹¶é‡ç”¨å®ƒã€‚

â€œæ–¹æ³•ä¸€â€çš„**çœŸæ­£ä½æ•ˆ**ä¹‹å¤„åœ¨äºï¼š$W_x$ å’Œ $W_h$ åœ¨ $t=1$ æ—¶çš„å±€éƒ¨è´¡çŒ®ï¼Œéœ€è¦**æ‰€æœ‰æœªæ¥æŸå¤±**ï¼ˆ$\ell_2, \ell_3, \dots, \ell_{10}$ï¼‰ä¼ æ’­å›æ¥çš„**æ€»å’Œ**ï¼Œè€Œä¸ä»…ä»…æ˜¯ $\ell_{10}$ è¿™ä¸€æ¡è·¯å¾„ã€‚

è¦è®¡ç®— $t=1$ çš„æ€»è´¡çŒ®ï¼Œæ‚¨å¿…é¡»**æ‰‹åŠ¨è®¡ç®—å¹¶æ±‚å’Œ 10 æ¡ä¸åŒçš„ä¼ æ’­é“¾**ï¼š

1.  **$\ell_1 \to h_1$ çš„è´¡çŒ®ï¼š**
    $C_1 = \frac{\partial \ell_1}{\partial h_1} = h_1$
2.  **$\ell_2 \to h_1$ çš„è´¡çŒ®ï¼š**
    $C_2 = \frac{\partial \ell_2}{\partial h_2} \cdot \frac{\partial h_2}{\partial h_1} = h_2 \cdot W_h$
3.  **$\ell_3 \to h_1$ çš„è´¡çŒ®ï¼š**
    $C_3 = \frac{\partial \ell_3}{\partial h_3} \cdot \frac{\partial h_3}{\partial h_2} \cdot \frac{\partial h_2}{\partial h_1} = h_3 \cdot (W_h)^2$
...
10. **$\ell_{10} \to h_1$ çš„è´¡çŒ®ï¼š**
    $C_{10} = \frac{\partial \ell_{10}}{\partial h_{10}} \cdot \dots \cdot \frac{\partial h_2}{\partial h_1} = h_{10} \cdot (W_h)^9$

åœ¨â€œæ–¹æ³•ä¸€â€ä¸­ï¼Œè¦è®¡ç®— $W_x$ å’Œ $W_h$ åœ¨ $t=1$ çš„æ€»è´¡çŒ®ï¼Œæ‚¨å¿…é¡»ï¼š
1.  **æ‰‹åŠ¨è®¡ç®—æ‰€æœ‰ 10 æ¡è·¯å¾„** $C_1, C_2, \dots, C_{10}$ã€‚
2.  **å°†å®ƒä»¬æ±‚å’Œï¼š** $C_{\text{total}} = C_1 + C_2 + \dots + C_{10}$ã€‚
3.  **ç”¨äº $W_x$ï¼š** $\text{Gradient}_{W_x} = C_{\text{total}} \cdot \frac{\partial h_1}{\partial W_x}\big|_{\text{local}}$
4.  **ç”¨äº $W_h$ï¼š** $\text{Gradient}_{W_h} = C_{\text{total}} \cdot \frac{\partial h_1}{\partial W_h}\big|_{\text{local}}$

â€œæ–¹æ³•ä¸€â€çš„ä½æ•ˆåœ¨äºæ‚¨éœ€è¦**æ‰‹åŠ¨è®¡ç®—å¹¶å­˜å‚¨ $O(T^2)$ æ¡ï¼ˆ$10+9+8+\dots+1 = 55$ æ¡ï¼‰**è¿™æ ·çš„è·¯å¾„æ¥è®¡ç®—æ€»æ¢¯åº¦ã€‚

#### æ–¹æ³•äºŒçš„çœŸæ­£ä¼˜åŠ¿ï¼šè‡ªåŠ¨æ±‚å’Œ

â€œæ–¹æ³•äºŒâ€ï¼ˆBPTT ç®—æ³•ï¼‰æ˜¯ä¸€ç§**è‡ªåŠ¨å®Œæˆ**ä¸Šè¿°æ‰€æœ‰æ±‚å’Œçš„ã€æå…¶é«˜æ•ˆçš„åŠ¨æ€è§„åˆ’ç®—æ³•ã€‚

å½“æˆ‘ä»¬æœ€ç»ˆè®¡ç®—åˆ° $\frac{\partial L}{\partial h_1}$ æ—¶ï¼Œæ ¹æ®é€’å½’å…¬å¼ï¼š
$$\frac{\partial L}{\partial h_1} = \frac{\partial \ell_1}{\partial h_1} + \frac{\partial L}{\partial h_2} \cdot \frac{\partial h_2}{\partial h_1}$$

è¿™ä¸ª $\frac{\partial L}{\partial h_1}$ çš„**æœ€ç»ˆè®¡ç®—ç»“æœ**ï¼Œ**åœ¨æ•°å­¦ä¸Šç­‰ä»·äº**ï¼š
$$\frac{\partial L}{\partial h_1} = C_1 + C_2 + \dots + C_{10}$$

* **é˜¶æ®µä¸€ (å€’åºé€’å½’)ï¼š** æˆ‘ä»¬åªèŠ±äº† $O(T)$ï¼ˆå³ 10 æ­¥ï¼‰çš„æ—¶é—´ï¼Œå°±è®¡ç®—å‡ºäº† $\frac{\partial L}{\partial h_1}$ã€‚è¿™ä¸ªå€¼**å·²ç»è‡ªåŠ¨åŒ…å«äº†**æ‰€æœ‰ 10 æ¡è·¯å¾„ $C_1$ åˆ° $C_{10}$ çš„æ€»å’Œã€‚
* **é˜¶æ®µäºŒ (å‚æ•°è®¡ç®—)ï¼š** $W_x$ å’Œ $W_h$ ç›´æ¥é‡ç”¨è¿™ä¸ª**å·²ç»æ±‚å’Œå®Œæ¯•**çš„ $\frac{\partial L}{\partial h_1}$ã€‚

#### å¤æ‚åº¦ç»“è®º

* **æ–¹æ³•ä¸€ï¼ˆä½æ•ˆï¼‰ï¼š** $O(T^2)$ã€‚æ€»æ“ä½œæ¬¡æ•°ä¸ $1 + 2 + \dots + T = \frac{T(T+1)}{2}$ æˆæ­£æ¯”ã€‚å¦‚æœåºåˆ—é•¿åº¦ $T$ å¢åŠ  10 å€ï¼Œè®¡ç®—é‡å¢åŠ  **100 å€**ã€‚
* **æ–¹æ³•äºŒï¼ˆBPTTï¼‰ï¼š** $O(T)$ã€‚æ€»æ“ä½œæ¬¡æ•°æ˜¯ é˜¶æ®µä¸€ $O(T)$ + é˜¶æ®µäºŒ $O(T)$ = $O(T)$ã€‚å¦‚æœåºåˆ—é•¿åº¦ $T$ å¢åŠ  10 å€ï¼Œè®¡ç®—é‡åªå¢åŠ  **10 å€**ã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ $\frac{\partial L}{\partial h_t}$ çš„é€’å½’ç®—æ³•æ˜¯è®­ç»ƒ RNN çš„å”¯ä¸€å¯è¡Œæ–¹æ³•ã€‚

è¯´ç™½äº†ï¼Œå°±æ˜¯åªè®¡ç®—ä¸€æ¬¡ï¼Œå¤šæ¬¡é‡å¤åˆ©ç”¨ã€‚

## 6.3 æˆªæ–­æ—¶é—´æ­¥/éšæœº/å¸¸è§„æˆªæ–­

åœ¨å®é™…çš„åº”ç”¨ä¸­ï¼Œå®Œæ•´çš„è®¡ç®—ï¼Œè®¡ç®—é‡è¿‡å¤§ã€‚å› æ­¤ï¼Œé‡‡ç”¨è¿‘ä¼¼è®¡ç®—ã€‚

ä¸€ç§æ˜¯å«å¸¸è§„æˆªæ–­ï¼Œå¦å¤–ä¸€ç§å«éšæœºæˆªæ–­ã€‚

å¸¸è§„æˆªæ–­ï¼š æ˜¯å·¥ä¸šç•Œå’Œå­¦æœ¯ç•Œæœ€å¸¸ç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œåªè¦æ±‚å®ƒèƒ½å­¦ä¹ æœ€è¿‘ $\tau$ æ­¥çš„ä¾èµ–å…³ç³»ï¼Œä½¿ç”¨çª—å£çš„æ€æƒ³ã€‚

æœºåˆ¶ï¼ˆdetach() çš„ä½œç”¨ï¼‰ï¼šå‰å‘ä¼ æ’­ï¼ˆçœ‹ç”µå½±æ—¶ï¼‰ï¼š ä½ ä¼šå¸¦ç€ä¸Šä¸€é›†çš„è®°å¿†ï¼ˆéšçŠ¶æ€ $h_{t-1}$ï¼‰å»çœ‹ä¸‹ä¸€é›†ï¼ˆ$h_t$ï¼‰ã€‚ä¿¡æ¯å¯ä»¥ä»å¤´æµåˆ°å°¾ã€‚

åå‘ä¼ æ’­ï¼ˆå†™å½±è¯„æ—¶ï¼‰ï¼š å½“ä½ å†™ç¬¬ 5 é›†çš„å½±è¯„ï¼ˆè®¡ç®— $\ell_5$ çš„æ¢¯åº¦ï¼‰æ—¶ï¼Œä½ åªä¼šå›é¡¾ç¬¬ 5 é›†çš„å†…å®¹ï¼ˆæ—¶é—´æ­¥ $t=41$ åˆ° $50$ï¼‰ã€‚ä½ ä¸ä¼šè®©è¿™ä¸€é›†çš„é”™è¯¯å»ä¿®æ­£ä½ å¯¹ç¬¬ 4 é›†çš„è®°å¿†ã€‚

detach() å°±å¥½æ¯”ä¸€ä¸ªæ¢¯åº¦çš„â€œåœæ­¢æ ‡å¿—â€ã€‚å®ƒå…è®¸ä¿¡æ¯ï¼ˆ$h_t$ï¼‰åœ¨å‰å‘ä¼ æ’­æ—¶é€šè¿‡ï¼Œä½†é˜»æ­¢æ¢¯åº¦ï¼ˆ$\frac{\partial L}{\partial h_t}$ï¼‰åœ¨åå‘ä¼ æ’­æ—¶æµè¿‡ã€‚


![alt text](../../../assets/img/notes/rnn/figures/8.7.1.png)

## 6.4 é—®é¢˜






