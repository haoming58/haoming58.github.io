//@version=5
strategy("ç§»åŠ¨å¹³å‡çº¿äº¤æ˜“ç­–ç•¥ MA Strategy", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// ==================== å‚æ•°è®¾ç½® ====================
// å‡çº¿å‘¨æœŸ
ma5_length = input.int(5, "MA5å‘¨æœŸ", minval=1)
ma10_length = input.int(10, "MA10å‘¨æœŸ", minval=1)
ma20_length = input.int(20, "MA20å‘¨æœŸ", minval=1)
ma60_length = input.int(60, "MA60å‘¨æœŸ", minval=1)

// æ˜¾ç¤ºè®¾ç½®
show_ma5 = input.bool(true, "æ˜¾ç¤ºMA5")
show_ma10 = input.bool(true, "æ˜¾ç¤ºMA10")
show_ma20 = input.bool(true, "æ˜¾ç¤ºMA20")
show_ma60 = input.bool(true, "æ˜¾ç¤ºMA60")

// ä¿¡å·è®¾ç½®
enable_golden_cross = input.bool(true, "å¯ç”¨é‡‘å‰ä¿¡å·", group="ä¹°å…¥ä¿¡å·")
enable_price_cross_up = input.bool(true, "å¯ç”¨ä»·æ ¼ä¸Šç©¿MA10ä¿¡å·", group="ä¹°å…¥ä¿¡å·")
enable_bullish_alignment = input.bool(true, "å¯ç”¨å¤šå¤´æ’åˆ—ä¿¡å·", group="ä¹°å…¥ä¿¡å·")

enable_death_cross = input.bool(true, "å¯ç”¨æ­»å‰ä¿¡å·", group="å–å‡ºä¿¡å·")
enable_price_cross_down = input.bool(true, "å¯ç”¨ä»·æ ¼ä¸‹ç©¿MA10ä¿¡å·", group="å–å‡ºä¿¡å·")
enable_bearish_alignment = input.bool(true, "å¯ç”¨ç©ºå¤´æ’åˆ—ä¿¡å·", group="å–å‡ºä¿¡å·")

// ==================== è®¡ç®—å‡çº¿ ====================
ma5 = ta.sma(close, ma5_length)
ma10 = ta.sma(close, ma10_length)
ma20 = ta.sma(close, ma20_length)
ma60 = ta.sma(close, ma60_length)

// ==================== ç»˜åˆ¶å‡çº¿ ====================
plot(show_ma5 ? ma5 : na, "MA5", color=color.new(color.red, 0), linewidth=2)
plot(show_ma10 ? ma10 : na, "MA10", color=color.new(color.orange, 0), linewidth=2)
plot(show_ma20 ? ma20 : na, "MA20", color=color.new(color.blue, 0), linewidth=2)
plot(show_ma60 ? ma60 : na, "MA60", color=color.new(color.purple, 0), linewidth=2)

// ==================== ä¹°å…¥ä¿¡å·æ£€æµ‹ ====================

// 1. é‡‘å‰ä¿¡å·ï¼šMA5å‘ä¸Šçªç ´MA10
golden_cross_5_10 = ta.crossover(ma5, ma10)
// MA10å‘ä¸Šçªç ´MA20
golden_cross_10_20 = ta.crossover(ma10, ma20)

// 2. ä»·æ ¼ä»ä¸‹å‘ä¸Šç©¿è¶ŠMA10ï¼Œä¸”MA5åœ¨MA10ä¸Šæ–¹
price_cross_up = ta.crossover(close, ma10) and ma5 > ma10

// 3. å¤šå¤´æ’åˆ—ï¼šMA5 > MA10 > MA20 > MA60
bullish_alignment = ma5 > ma10 and ma10 > ma20 and ma20 > ma60

// ç»¼åˆä¹°å…¥æ¡ä»¶ - éœ€è¦æ›´å¼ºçš„ä¿¡å·ç»„åˆ
buy_signal = false

// å¼ºä¹°å…¥ä¿¡å·ï¼šé‡‘å‰ + å¤šå¤´æ’åˆ—
strong_buy = (golden_cross_5_10 or golden_cross_10_20) and bullish_alignment

// ä¸­ç­‰ä¹°å…¥ä¿¡å·ï¼šä»·æ ¼ä¸Šç©¿MA10 + MA5åœ¨MA10ä¸Šæ–¹ + å¤šå¤´æ’åˆ—
medium_buy = price_cross_up and bullish_alignment

// åªåœ¨å¼ºä¿¡å·æˆ–ä¸­ç­‰ä¿¡å·æ—¶æ‰ä¹°å…¥
if enable_golden_cross and strong_buy
    buy_signal := true
if enable_price_cross_up and medium_buy
    buy_signal := true

// ==================== å–å‡ºä¿¡å·æ£€æµ‹ ====================

// 1. æ­»å‰ä¿¡å·ï¼šMA5å‘ä¸‹è·Œç ´MA10
death_cross_5_10 = ta.crossunder(ma5, ma10)
// MA10å‘ä¸‹è·Œç ´MA20
death_cross_10_20 = ta.crossunder(ma10, ma20)

// 2. ä»·æ ¼ä»ä¸Šå‘ä¸‹ç©¿è¶ŠMA10ï¼Œä¸”MA5åœ¨MA10ä¸‹æ–¹
price_cross_down = ta.crossunder(close, ma10) and ma5 < ma10

// 3. ç©ºå¤´æ’åˆ—ï¼šMA5 < MA10 < MA20 < MA60
bearish_alignment = ma5 < ma10 and ma10 < ma20 and ma20 < ma60

// ç»¼åˆå–å‡ºæ¡ä»¶ - éœ€è¦æ›´å¼ºçš„ä¿¡å·ç»„åˆ
sell_signal = false

// å¼ºå–å‡ºä¿¡å·ï¼šæ­»å‰ + ç©ºå¤´æ’åˆ—
strong_sell = (death_cross_5_10 or death_cross_10_20) and bearish_alignment

// ä¸­ç­‰å–å‡ºä¿¡å·ï¼šä»·æ ¼ä¸‹ç©¿MA10 + MA5åœ¨MA10ä¸‹æ–¹ + ç©ºå¤´æ’åˆ—
medium_sell = price_cross_down and bearish_alignment

// åªåœ¨å¼ºä¿¡å·æˆ–ä¸­ç­‰ä¿¡å·æ—¶æ‰å–å‡º
if enable_death_cross and strong_sell
    sell_signal := true
if enable_price_cross_down and medium_sell
    sell_signal := true

// ==================== æ‰§è¡Œäº¤æ˜“ ====================
if buy_signal
    strategy.entry("ä¹°å…¥", strategy.long)
    
if sell_signal
    strategy.close("ä¹°å…¥")

// ==================== ç»˜åˆ¶ä¿¡å· ====================
// åªæ˜¾ç¤ºä¸»è¦ä¹°å–ä¿¡å·ï¼Œæ ‡è®°æ›´æ¸…æ™°
plotshape(buy_signal, title="ä¹°å…¥ä¿¡å·", location=location.belowbar, color=color.new(color.green, 0), style=shape.triangleup, text="ä¹°", textcolor=color.white, size=size.normal)

plotshape(sell_signal, title="å–å‡ºä¿¡å·", location=location.abovebar, color=color.new(color.red, 0), style=shape.triangledown, text="å–", textcolor=color.white, size=size.normal)

// ==================== èƒŒæ™¯é¢œè‰² ====================
// å¤šå¤´æ’åˆ—æ—¶èƒŒæ™¯æ·¡ç»¿è‰²
bgcolor(bullish_alignment ? color.new(color.green, 95) : na, title="å¤šå¤´æ’åˆ—èƒŒæ™¯")
// ç©ºå¤´æ’åˆ—æ—¶èƒŒæ™¯æ·¡çº¢è‰²
bgcolor(bearish_alignment ? color.new(color.red, 95) : na, title="ç©ºå¤´æ’åˆ—èƒŒæ™¯")

// ==================== ä¿¡æ¯é¢æ¿ ====================
var table infoTable = table.new(position.top_right, 2, 7, border_width=1)

if barstate.islast
    // æ ‡é¢˜
    table.cell(infoTable, 0, 0, "æŒ‡æ ‡", text_color=color.white, bgcolor=color.gray)
    table.cell(infoTable, 1, 0, "çŠ¶æ€", text_color=color.white, bgcolor=color.gray)
    
    // MAå€¼
    table.cell(infoTable, 0, 1, "MA5", text_color=color.white, bgcolor=color.red)
    table.cell(infoTable, 1, 1, str.tostring(ma5, "#.##"), text_color=color.white, bgcolor=color.red)
    
    table.cell(infoTable, 0, 2, "MA10", text_color=color.white, bgcolor=color.orange)
    table.cell(infoTable, 1, 2, str.tostring(ma10, "#.##"), text_color=color.white, bgcolor=color.orange)
    
    table.cell(infoTable, 0, 3, "MA20", text_color=color.white, bgcolor=color.blue)
    table.cell(infoTable, 1, 3, str.tostring(ma20, "#.##"), text_color=color.white, bgcolor=color.blue)
    
    table.cell(infoTable, 0, 4, "MA60", text_color=color.white, bgcolor=color.purple)
    table.cell(infoTable, 1, 4, str.tostring(ma60, "#.##"), text_color=color.white, bgcolor=color.purple)
    
    // æ’åˆ—çŠ¶æ€
    alignment_text = bullish_alignment ? "å¤šå¤´æ’åˆ— ğŸ“ˆ" : bearish_alignment ? "ç©ºå¤´æ’åˆ— ğŸ“‰" : "æ— æ˜ç¡®æ’åˆ—"
    alignment_color = bullish_alignment ? color.green : bearish_alignment ? color.red : color.gray
    table.cell(infoTable, 0, 5, "æ’åˆ—", text_color=color.white, bgcolor=color.gray)
    table.cell(infoTable, 1, 5, alignment_text, text_color=color.white, bgcolor=alignment_color)
    
    // å½“å‰ä¿¡å·
    current_signal = buy_signal ? "ä¹°å…¥ ğŸš€" : sell_signal ? "å–å‡º âš ï¸" : "è§‚æœ› â¸ï¸"
    signal_color = buy_signal ? color.green : sell_signal ? color.red : color.gray
    table.cell(infoTable, 0, 6, "ä¿¡å·", text_color=color.white, bgcolor=color.gray)
    table.cell(infoTable, 1, 6, current_signal, text_color=color.white, bgcolor=signal_color)

// ==================== è­¦æŠ¥æ¡ä»¶ ====================
// åªä¿ç•™é‡è¦çš„ä¹°å–ä¿¡å·è­¦æŠ¥
alertcondition(buy_signal, title="ä¹°å…¥ä¿¡å·", message="ğŸš€ å‡ºç°å¼ºçƒˆä¹°å…¥ä¿¡å·ï¼é‡‘å‰+å¤šå¤´æ’åˆ—")
alertcondition(sell_signal, title="å–å‡ºä¿¡å·", message="âš ï¸ å‡ºç°å¼ºçƒˆå–å‡ºä¿¡å·ï¼æ­»å‰+ç©ºå¤´æ’åˆ—")
alertcondition(bullish_alignment and not bullish_alignment[1], title="å¤šå¤´æ’åˆ—å½¢æˆ", message="ğŸ“ˆ å‡çº¿ç³»ç»Ÿå½¢æˆå¤šå¤´æ’åˆ—")
alertcondition(bearish_alignment and not bearish_alignment[1], title="ç©ºå¤´æ’åˆ—å½¢æˆ", message="ğŸ“‰ å‡çº¿ç³»ç»Ÿå½¢æˆç©ºå¤´æ’åˆ—")
